name: Claude Code Task Runner

on:
  schedule:
    # 5åˆ†ã”ã¨ã«å®Ÿè¡Œï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´å¯èƒ½ï¼‰
    - cron: '*/5 * * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      force_run:
        description: 'å¼·åˆ¶å®Ÿè¡Œ'
        required: false
        default: 'false'

jobs:
  run-claude-tasks:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Setup Claude Code credentials
        env:
          CLAUDE_CREDENTIALS: ${{ secrets.CLAUDE_CREDENTIALS }}
        run: |
          mkdir -p ~/.claude
          echo "$CLAUDE_CREDENTIALS" > ~/.claude/.credentials.json
          chmod 600 ~/.claude/.credentials.json

      - name: Debug - Verify Claude CLI installation
        run: |
          echo "Checking Claude CLI version..."
          claude --version || echo "Claude CLI version check failed"
          echo "Checking Claude CLI path..."
          which claude || echo "Claude CLI not found in PATH"
          echo "Checking credentials file..."
          ls -la ~/.claude/.credentials.json || echo "Credentials file not found"
          echo "Credentials file structure (first 100 chars)..."
          head -c 100 ~/.claude/.credentials.json || echo "Cannot read credentials"

      - name: Test - Simple Claude CLI execution
        timeout-minutes: 2
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "Testing simple Claude CLI command with timeout..."
          timeout 60s claude --print "Hello" --output-format text || echo "Command failed or timed out"

      - name: Install dependencies
        run: |
          cd scripts
          npm install

      - name: Run Claude Code task processor
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GOOGLE_SHEETS_CREDENTIALS: ${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        run: |
          cd scripts
          node process-tasks.js

      - name: Commit and push changes
        run: |
          git config --local user.email "claude-bot@github.com"
          git config --local user.name "Claude Code Bot"
          git add -A
          git add reports/ || true
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Claude Code: Task execution results and session reports [skip ci]" && git push)
